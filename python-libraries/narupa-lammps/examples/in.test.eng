###################################################
##############Uniaxial tensile simulation #########
###################################################

########### Unit cell construction & Atomic force field ###########

units           real  # 
atom_style      full  # 
boundary        p p p  # 

#non-bonded energy
#Pair_modify for long range calculation
#Kspace_style for coulomb energy calculation

atom_modify     map array
pair_style      lj/class2/coul/long 9.5 9.5
dielectric      1.0
pair_modify     tail yes
kspace_style    pppm 0.000001

#Forcefield type

bond_style      class2
angle_style     class2
dihedral_style  class2
improper_style  class2

read_data       25NR60-1S.data  # Input file
velocity        all create 300 294 dist gaussian  # initial velocity
neighbor        2.0 bin
neigh_modify    delay 0 every 1 check yes
special_bonds   lj/coul 0.0 0.0 1.0

python         post_force_callback here """
from lammps import lammps
from narupa.lammps import LammpsHook
h = LammpsHook()

def post_force_callback(lmp,v):
  h.lammps_hook(lmp)
"""

fix     3 all python/invoke 1 post_force post_force_callback

minimize        1.0e-2 1.0e-4 90000 1000  # Energy minimization

thermo_style    custom step temp pe ke evdwl ecoul elong ebond eangle edihed
thermo          100000

timestep        1.0   # timestep (/fs)

############# Relaxation simulation (ensemble) ################
############## NVT->NPT 
fix             Mynvt2 all nvt temp 300.0 300.0 20.0 drag 2.0 # NVT ensemble (300K)
dump            Myatom2 all atom 400000 1EQ-300-1NVT_25NR60-1S.pos
dump_modify     Myatom2 image yes scale yes
# 
# 
restart         2000000 1EQ-300_25NR60-1S.restart        # writing restart file
run_style       verlet                  # Run style (Verlet)
run             4000000                 # Run step

unfix           Mynvt2                  # ensemble terminate
undump          Myatom2                 # 

fix             Mynpt1 all npt temp 300.0 300.0 100.0 iso 1.0 1.0 1000.0 drag 0.2       # NPT ensemble (300K,1ATM)

dump            Myatom3 all atom 400000 1EQ-300-2NPT_25NR60-1S.pos

# 
# 
restart         2000000 1EQ-300_25NR60-1S.restart        # writing restart file
run_style       verlet                  # Run style (Verlet)
run             8000000                 # Run step

unfix           Mynpt1                  # ensemble terminate
undump          Myatom3                 # 

############# Tensile simulation ################
#computation of stress
compute         Cstress all stress/atom  NULL # stress/atom
compute         Ctemp all temp  # temperature
compute         Cpress all pressure Ctemp  # pressure at temp
compute         Cstress_cell all reduce sum c_Cstress[1] c_Cstress[2] c_Cstress[3]  # average stress

#응력/변형률 계산을 위한 변수 지정

variable        Sxx equal c_Cstress_cell[1]/vol   #ATM Stress(x)
variable        Syy equal c_Cstress_cell[2]/vol   #ATM Stress(y)
variable        Szz equal c_Cstress_cell[3]/vol   #ATM Stress(z)
variable        Lxx equal lx  # cell length(x)
variable        Lyy equal ly  # cell length(y)
variable        Lzz equal lz  # cell length(z)
variable        Volume equal vol  # volume

#tensil simulation

fix             Flength all ave/time 10 1000 20000 v_Lxx v_Lyy v_Lzz v_Volume file 25NR1S-E8-300K-unix1-leng.txt # average cell length and volume 

fix             Fstress all ave/time 10 1000 20000 v_Sxx v_Syy v_Szz file 25NR1S-E8-300K-unix1-stress.txt        # average stress

fix             Fnpt_tension all npt temp 300.0 300.0 100 y 1.0 1.0 20.0 z 1.0 1.0 20.0 drag 10.0     # NPT ensemble

fix             Ftension all deform 200 x erate 0.0000001 remap x

# unit cell tensile of deformation at every 200 steps

thermo_style    custom step temp pe ke evdwl ecoul elong ebond eangle edihed pxx pyy pzz v_Sxx v_Syy v_Szz lx ly lz  #
thermo          100000 #

dump            Datom_tension all atom 100000 25NR1S-E8-300K-unix1.pos
dump_modify     Datom_tension image yes scale yes
# 

restart         200000 25NR1S-E8-300K-unix1  # 
run             2000000   # Run step
